<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GIFè§£æå™¨ç¤ºä¾‹ - å®Œå–„ç‰ˆ</title>
    <script src="/gif/gifuct-js.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .upload-area {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background-color: #fafafa;
        transition: all 0.3s ease;
      }

      .upload-area:hover {
        border-color: #007bff;
        background-color: #f0f8ff;
      }

      .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
      }

      .upload-btn:hover {
        background: #0056b3;
      }

      .url-input {
        width: 300px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin: 10px;
      }

      .controls {
        margin: 20px 0;
        text-align: center;
      }

      .control-btn {
        background: #28a745;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 0 5px;
        font-size: 14px;
      }

      .control-btn:hover {
        background: #218838;
      }

      .control-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .info-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }

      .info-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }

      .info-section h3 {
        margin: 0 0 10px 0;
        color: #007bff;
      }

      .canvas-container {
        text-align: center;
        margin: 20px 0;
        background: #fff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
      }

      .canvas-container canvas {
        border: 1px solid #ddd;
        border-radius: 5px;
        max-width: 100%;
        height: auto;
      }

      .frame-info {
        margin: 10px 0;
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
        font-family: monospace;
      }

      .error {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .warning {
        color: #856404;
        background: #fff3cd;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .success {
        color: #155724;
        background: #d4edda;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .progress {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        transition: width 0.3s ease;
      }

      .export-section {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }

      .export-btn {
        background: #6f42c1;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }

      .export-btn:hover {
        background: #5a32a3;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        border-bottom: 2px solid transparent;
      }

      .tab.active {
        border-bottom-color: #007bff;
        color: #007bff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>ğŸ¨ GIFè§£æå™¨ç¤ºä¾‹ - å®Œå–„ç‰ˆ</h1>

      <div class="upload-area" id="uploadArea">
        <p>æ‹–æ‹½GIFæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–è€…ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
        <button
          class="upload-btn"
          onclick="document.getElementById('fileInput').click()"
        >
          é€‰æ‹©æ–‡ä»¶
        </button>
        <input type="file" id="fileInput" class="file-input" accept=".gif" />

        <p>æˆ–è€…ä»URLåŠ è½½ï¼š</p>
        <input
          type="url"
          id="urlInput"
          class="url-input"
          placeholder="è¾“å…¥GIFæ–‡ä»¶URL"
        />
        <button class="upload-btn" onclick="loadFromUrl()">ä»URLåŠ è½½</button>
      </div>

      <div id="loadingIndicator" style="display: none">
        <div class="progress">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <p style="text-align: center">æ­£åœ¨è§£æGIFæ–‡ä»¶...</p>
      </div>

      <div id="content" style="display: none">
        <div class="tabs">
          <button class="tab active" onclick="showTab('viewer')">æŸ¥çœ‹å™¨</button>
          <button class="tab" onclick="showTab('info')">è¯¦ç»†ä¿¡æ¯</button>
          <button class="tab" onclick="showTab('frames')">å¸§ç®¡ç†</button>
          <button class="tab" onclick="showTab('tools')">å·¥å…·</button>
          <button class="tab" onclick="showTab('compress')">å‹ç¼©</button>
        </div>

        <!-- æŸ¥çœ‹å™¨æ ‡ç­¾é¡µ -->
        <div id="viewer" class="tab-content active">
          <div class="canvas-container">
            <canvas id="gifCanvas"></canvas>
            <div class="frame-info" id="frameInfo"></div>
          </div>

          <div class="controls">
            <button class="control-btn" onclick="renderer.reset()">é‡ç½®</button>
            <button class="control-btn" onclick="renderer.prevFrame()">
              ä¸Šä¸€å¸§
            </button>
            <button class="control-btn" id="playBtn" onclick="togglePlay()">
              æ’­æ”¾
            </button>
            <button class="control-btn" onclick="renderer.nextFrame()">
              ä¸‹ä¸€å¸§
            </button>
            <button class="control-btn" onclick="exportCurrentFrame()">
              å¯¼å‡ºå½“å‰å¸§
            </button>
          </div>
        </div>

        <!-- è¯¦ç»†ä¿¡æ¯æ ‡ç­¾é¡µ -->
        <div id="info" class="tab-content">
          <div class="info-panel">
            <div class="info-section">
              <h3>åŸºæœ¬ä¿¡æ¯</h3>
              <div id="basicInfo"></div>
            </div>
            <div class="info-section">
              <h3>æŠ€æœ¯å‚æ•°</h3>
              <div id="technicalInfo"></div>
            </div>
          </div>

          <div class="info-section">
            <h3>è§£ææ—¥å¿—</h3>
            <div id="parseLog"></div>
          </div>
        </div>

        <!-- å¸§ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="frames" class="tab-content">
          <div id="framesList"></div>
        </div>
        <!-- å·¥å…·æ ‡ç­¾é¡µ -->
        <div id="tools" class="tab-content">
          <div class="export-section">
            <h3>å¯¼å‡ºå·¥å…·</h3>
            <button class="export-btn" onclick="exportAllFrames()">
              å¯¼å‡ºæ‰€æœ‰å¸§
            </button>
            <button class="export-btn" onclick="createSpriteSheet()">
              åˆ›å»ºç²¾çµå›¾
            </button>
            <button class="export-btn" onclick="exportPalette()">
              å¯¼å‡ºè°ƒè‰²æ¿
            </button>
            <button class="export-btn" onclick="downloadAnalysis()">
              ä¸‹è½½åˆ†ææŠ¥å‘Š
            </button>
          </div>

          <div class="export-section">
            <h3>åˆ†æå·¥å…·</h3>
            <div id="analysisResult"></div>
          </div>
        </div>

        <!-- å‹ç¼©æ ‡ç­¾é¡µ -->
        <div id="compress" class="tab-content">
          <div class="export-section">
            <h3>GIFå‹ç¼©è®¾ç½®</h3>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
              "
            >
              <div>
                <label style="display: block; margin-bottom: 5px"
                  ><strong>ç›®æ ‡å°ºå¯¸:</strong></label
                >
                <input
                  type="number"
                  id="compressWidth"
                  placeholder="å®½åº¦ (ç•™ç©ºä¿æŒåŸå§‹)"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                />
                <input
                  type="number"
                  id="compressHeight"
                  placeholder="é«˜åº¦ (ç•™ç©ºä¿æŒåŸå§‹)"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-top: 5px;
                  "
                />
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px"
                  ><strong>å‹ç¼©è´¨é‡:</strong>
                  <span id="qualityValue">15</span></label
                >
                <input
                  type="range"
                  id="compressQuality"
                  min="1"
                  max="30"
                  value="15"
                  style="width: 100%"
                  oninput="updateQualityValue(this.value)"
                />
                <small style="color: #666"
                  >æ•°å­—è¶Šå°è´¨é‡è¶Šé«˜ï¼Œå»ºè®®15-20è·å¾—æœ€ä½³å‹ç¼©æ¯”</small
                >
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px"
                  ><strong>æœ€å¤§å¸§æ•°:</strong></label
                >
                <input
                  type="number"
                  id="maxFrames"
                  placeholder="ç•™ç©ºä¿æŒæ‰€æœ‰å¸§"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                />
                <small style="color: #666"
                  >ç•™ç©ºå°†ä¿æŒåŸå§‹GIFçš„æ‰€æœ‰å¸§å’Œæ•ˆæœ</small
                >
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px"
                  ><strong>å¸§å¤„ç†ç­–ç•¥:</strong></label
                >
                <select
                  id="frameStrategy"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                  "
                >
                  <option value="keep-all">ä¿æŒæ‰€æœ‰å¸§ (æ¨è)</option>
                  <option value="auto-skip">æ ¹æ®è´¨é‡è‡ªåŠ¨è·³å¸§</option>
                  <option value="manual-skip">æ‰‹åŠ¨è®¾ç½®è·³å¸§</option>
                </select>
                <input
                  type="number"
                  id="frameStep"
                  placeholder="å¸§æ­¥é•¿ (å¦‚: 2è¡¨ç¤ºæ¯éš”1å¸§)"
                  style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    margin-top: 5px;
                    display: none;
                  "
                />
                <small style="color: #666">ä¿æŒæ‰€æœ‰å¸§å¯ç¡®ä¿GIFæ•ˆæœå®Œæ•´</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 15px"
                  ><strong>é«˜çº§é€‰é¡¹:</strong></label
                >
                <label style="display: block; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="useDirectPixelMethod"
                    style="margin-right: 8px"
                    checked
                  />
                  ä½¿ç”¨æœ€ä¼˜åŒ–ç®—æ³• (ç±»ä¼¼å‚è€ƒä»£ç )
                </label>
                <label style="display: block; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="useImprovedMethod"
                    style="margin-right: 8px"
                    checked
                  />
                  ä½¿ç”¨æ”¹è¿›å‹ç¼©ç®—æ³• (å¤‡é€‰)
                </label>
                <label style="display: block; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="enableDither"
                    style="margin-right: 8px"
                  />
                  å¯ç”¨æŠ–åŠ¨ (æé«˜æ¸å˜è´¨é‡)
                </label>
                <label style="display: block; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="debugMode"
                    style="margin-right: 8px"
                  />
                  è°ƒè¯•æ¨¡å¼
                </label>
              </div>
            </div>

            <div
              id="compressionPreview"
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: none;
              "
            >
              <h4 style="margin: 0 0 10px 0">å‹ç¼©é¢„è§ˆ</h4>
              <div id="previewContent"></div>
            </div>
            <div style="text-align: center">
              <button
                class="export-btn"
                onclick="previewCompression()"
                style="background: #17a2b8"
              >
                é¢„è§ˆå‹ç¼©æ•ˆæœ
              </button>
              <button
                class="export-btn"
                onclick="startCompression()"
                style="background: #dc3545"
              >
                å¼€å§‹å‹ç¼©
              </button>
              <button
                class="export-btn"
                onclick="resetCompression()"
                style="background: #6c757d"
              >
                é‡ç½®å‹ç¼©
              </button>
            </div>
          </div>

          <div id="compressionProgress" style="display: none; margin-top: 20px">
            <h4>å‹ç¼©è¿›åº¦</h4>
            <div class="progress">
              <div
                class="progress-bar"
                id="compressionProgressBar"
                style="width: 0%"
              ></div>
            </div>
            <div
              id="compressionStatus"
              style="text-align: center; margin-top: 10px"
            >
              å‡†å¤‡ä¸­...
            </div>
          </div>

          <div id="compressionResult" style="display: none; margin-top: 20px">
            <h4>å‹ç¼©ç»“æœ</h4>
            <div id="compressionResultContent"></div>
          </div>
        </div>
      </div>
    </div>
    <script src="GifParser.js"></script>
    <script src="imageUtils.js"></script>
    <script src="./gif/gif.js"></script>
    <script>
      let gifParser = null;
      let renderer = null;
      let gifData = null;
      let imageUtils = null;
      let originalFileSize = 0; // ä¿å­˜åŸå§‹æ–‡ä»¶å¤§å°

      // å…¨å±€å˜é‡ç”¨äºç®¡ç†å‹ç¼©çŠ¶æ€
      let currentCompressionTimeout = null;
      let compressionAborted = false; // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        setupFileUpload();
        setupDragAndDrop();
        setupFrameStrategySelector();

        // åˆå§‹åŒ–å›¾åƒå·¥å…·
        if (typeof ImageUtils !== "undefined") {
          imageUtils = new ImageUtils();
          console.log("å›¾åƒå‹ç¼©å·¥å…·åˆå§‹åŒ–æˆåŠŸ");
        } else {
          console.warn("ImageUtilsæœªåŠ è½½ï¼Œå‹ç¼©åŠŸèƒ½ä¸å¯ç”¨");
        }
      });

      // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
      function setupFileUpload() {
        const fileInput = document.getElementById("fileInput");
        fileInput.addEventListener("change", handleFileSelect);
      }

      // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
      function setupDragAndDrop() {
        const uploadArea = document.getElementById("uploadArea");

        uploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("dragover");

          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].type === "image/gif") {
            handleFile(files[0]);
          } else {
            showMessage("è¯·é€‰æ‹©GIFæ–‡ä»¶", "error");
          }
        });
      }

      // è®¾ç½®å¸§ç­–ç•¥é€‰æ‹©å™¨
      function setupFrameStrategySelector() {
        const frameStrategy = document.getElementById("frameStrategy");
        const frameStep = document.getElementById("frameStep");

        frameStrategy.addEventListener("change", function () {
          if (this.value === "manual-skip") {
            frameStep.style.display = "block";
          } else {
            frameStep.style.display = "none";
          }
        });
      }

      // å¤„ç†æ–‡ä»¶é€‰æ‹©
      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file && file.type === "image/gif") {
          handleFile(file);
        } else {
          showMessage("è¯·é€‰æ‹©GIFæ–‡ä»¶", "error");
        }
      } // å¤„ç†æ–‡ä»¶
      async function handleFile(file) {
        showLoading(true);

        // ä¿å­˜åŸå§‹æ–‡ä»¶å¤§å°
        originalFileSize = file.size;

        try {
          gifParser = await GifParser.fromFile(file, {
            strict: false,
            validateFrames: true,
            maxFrames: 500,
          });

          gifData = gifParser.parse();
          await initializeViewer();
          showMessage(
            `æˆåŠŸåŠ è½½GIFæ–‡ä»¶: ${file.name} (${(originalFileSize / 1024).toFixed(
              1
            )}KB)`,
            "success"
          );
        } catch (error) {
          showMessage(`åŠ è½½å¤±è´¥: ${error.message}`, "error");
          console.error(error);
        }

        showLoading(false);
      } // ä»URLåŠ è½½
      async function loadFromUrl() {
        const url = document.getElementById("urlInput").value.trim();
        if (!url) {
          showMessage("è¯·è¾“å…¥URL", "error");
          return;
        }

        showLoading(true);

        try {
          // å…ˆè·å–æ–‡ä»¶å¤§å°
          const response = await fetch(url, { method: "HEAD" });
          originalFileSize =
            parseInt(response.headers.get("content-length")) || 0;

          gifParser = await GifParser.fromUrl(url, {
            strict: false,
            validateFrames: true,
            maxFrames: 500,
          });

          gifData = gifParser.parse();
          await initializeViewer();
          showMessage(
            `æˆåŠŸä»URLåŠ è½½GIFæ–‡ä»¶ (${(originalFileSize / 1024).toFixed(1)}KB)`,
            "success"
          );
        } catch (error) {
          showMessage(`åŠ è½½å¤±è´¥: ${error.message}`, "error");
          console.error(error);
        }

        showLoading(false);
      }

      // åˆå§‹åŒ–æŸ¥çœ‹å™¨
      async function initializeViewer() {
        const canvas = document.getElementById("gifCanvas");

        // åˆ›å»ºæ¸²æŸ“å™¨
        renderer = new GifRenderer(gifData, {
          autoPlay: false,
          loop: true,
          scale: 1,
          backgroundColor: "transparent",
        });

        // æ›¿æ¢ç”»å¸ƒ
        canvas.parentNode.replaceChild(renderer.canvas, canvas);
        renderer.canvas.id = "gifCanvas";

        // æ¸²æŸ“ç¬¬ä¸€å¸§
        if (gifData.frames.length > 0) {
          renderer.renderFrame(0);
          updateFrameInfo();
        }

        // æ˜¾ç¤ºå†…å®¹
        document.getElementById("content").style.display = "block";

        // æ›´æ–°ä¿¡æ¯é¢æ¿
        updateInfoPanels();
        updateFramesList();
        updateAnalysis();
      }

      // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
      function togglePlay() {
        const playBtn = document.getElementById("playBtn");

        if (renderer.isPlaying) {
          renderer.pause();
          playBtn.textContent = "æ’­æ”¾";
        } else {
          renderer.play((frameIndex, frame) => {
            updateFrameInfo();
          });
          playBtn.textContent = "æš‚åœ";
        }
      }

      // æ›´æ–°å¸§ä¿¡æ¯
      function updateFrameInfo() {
        const frameInfo = document.getElementById("frameInfo");
        const state = renderer.getPlaybackState();
        const frame = renderer.getFrameInfo(state.currentFrame);

        if (frame) {
          frameInfo.innerHTML = `
                    å¸§ ${frame.index + 1} / ${state.totalFrames} | 
                    å°ºå¯¸: ${frame.width}x${frame.height} | 
                    ä½ç½®: (${frame.left}, ${frame.top}) | 
                    å»¶è¿Ÿ: ${frame.delayTime * 10}ms |
                    å¤„ç†æ–¹å¼: ${getDisposalMethodName(frame.disposalMethod)} |
                    ${frame.transparentColorFlag ? "æœ‰é€æ˜" : "æ— é€æ˜"} |
                    ${frame.isInterlaced ? "äº¤é”™" : "éäº¤é”™"}
                `;
        }
      }

      // è·å–å¤„ç†æ–¹å¼åç§°
      function getDisposalMethodName(method) {
        const names = ["ä¸æŒ‡å®š", "ä¸å¤„ç†", "æ¢å¤èƒŒæ™¯", "æ¢å¤ä¸Šä¸€å¸§"];
        return names[method] || "æœªçŸ¥";
      }

      // æ›´æ–°ä¿¡æ¯é¢æ¿
      function updateInfoPanels() {
        const basicInfo = document.getElementById("basicInfo");
        const technicalInfo = document.getElementById("technicalInfo");
        const parseLog = document.getElementById("parseLog");

        const info = gifParser.getInfo();

        basicInfo.innerHTML = `
                <p><strong>ç‰ˆæœ¬:</strong> ${gifData.header.version}</p>
                <p><strong>å°ºå¯¸:</strong> ${info.width} x ${info.height}</p>
                <p><strong>å¸§æ•°:</strong> ${info.frameCount}</p>
                <p><strong>å¾ªç¯æ¬¡æ•°:</strong> ${
                  info.loopCount === 0 ? "æ— é™å¾ªç¯" : info.loopCount
                }</p>
                <p><strong>æ€»æ—¶é•¿:</strong> ${(
                  info.totalDuration / 1000
                ).toFixed(2)}ç§’</p>
            `;

        technicalInfo.innerHTML = `
                <p><strong>å…¨å±€é¢œè‰²è¡¨:</strong> ${
                  info.hasGlobalColorTable ? "æ˜¯" : "å¦"
                }</p>
                <p><strong>é¢œè‰²è¡¨å¤§å°:</strong> ${info.globalColorTableSize}</p>
                <p><strong>èƒŒæ™¯è‰²ç´¢å¼•:</strong> ${
                  gifData.logicalScreen.backgroundColorIndex
                }</p>
                <p><strong>é¢œè‰²åˆ†è¾¨ç‡:</strong> ${
                  gifData.logicalScreen.colorResolution
                }</p>
                <p><strong>åƒç´ å®½é«˜æ¯”:</strong> ${
                  gifData.logicalScreen.pixelAspectRatio
                }</p>
            `;

        // æ˜¾ç¤ºè§£ææ—¥å¿—
        let logHtml = "";
        if (gifData.errors.length > 0) {
          logHtml += '<h4 style="color: #dc3545;">é”™è¯¯:</h4>';
          gifData.errors.forEach((error) => {
            logHtml += `<div class="error">${error}</div>`;
          });
        }

        if (gifData.warnings.length > 0) {
          logHtml += '<h4 style="color: #856404;">è­¦å‘Š:</h4>';
          gifData.warnings.forEach((warning) => {
            logHtml += `<div class="warning">${warning}</div>`;
          });
        }

        if (gifData.errors.length === 0 && gifData.warnings.length === 0) {
          logHtml = '<div class="success">è§£æå®Œæˆï¼Œæ²¡æœ‰é”™è¯¯æˆ–è­¦å‘Š</div>';
        }

        parseLog.innerHTML = logHtml;
      }

      // æ›´æ–°å¸§åˆ—è¡¨
      function updateFramesList() {
        const framesList = document.getElementById("framesList");
        let html = "<h3>å¸§åˆ—è¡¨</h3>";

        gifData.frames.forEach((frame, index) => {
          html += `
                    <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px;">
                        <strong>å¸§ ${index + 1}</strong>
                        <button class="control-btn" onclick="renderer.gotoFrame(${index}); updateFrameInfo();" style="float: right;">æŸ¥çœ‹</button>
                        <br>
                        å°ºå¯¸: ${frame.width}x${frame.height} | 
                        ä½ç½®: (${frame.left}, ${frame.top}) | 
                        å»¶è¿Ÿ: ${frame.delayTime * 10}ms<br>
                        é¢œè‰²è¡¨å¤§å°: ${frame.colorTable.length} | 
                        æ•°æ®å¤§å°: ${frame.imageData.length} bytes
                    </div>
                `;
        });

        framesList.innerHTML = html;
      }

      // æ›´æ–°åˆ†æç»“æœ
      function updateAnalysis() {
        const analysisResult = document.getElementById("analysisResult");
        const analysis = GifUtils.analyzeGif(gifData);

        analysisResult.innerHTML = `
                <h4>æ€§èƒ½åˆ†æ</h4>
                <p><strong>æ€»åƒç´ æ•°:</strong> ${analysis.totalPixels.toLocaleString()}</p>
                <p><strong>å”¯ä¸€é¢œè‰²æ•°:</strong> ${analysis.uniqueColors}</p>
                <p><strong>å¹³å‡å¸§å»¶è¿Ÿ:</strong> ${analysis.averageFrameDelay.toFixed(
                  1
                )}ms</p>
                <p><strong>ä¼°ç®—FPS:</strong> ${analysis.framesPerSecond.toFixed(
                  1
                )}</p>
                <p><strong>ä¼°ç®—å†…å­˜ä½¿ç”¨:</strong> ${(
                  analysis.memoryUsage /
                  1024 /
                  1024
                ).toFixed(2)} MB</p>
            `;
      }

      // å¯¼å‡ºå½“å‰å¸§
      function exportCurrentFrame() {
        try {
          const dataUrl = renderer.exportFrame(undefined, "image/png", 0.92);
          downloadDataUrl(
            dataUrl,
            `frame_${renderer.getCurrentFrameIndex() + 1}.png`
          );
          showMessage("å½“å‰å¸§å¯¼å‡ºæˆåŠŸ", "success");
        } catch (error) {
          showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, "error");
        }
      }

      // å¯¼å‡ºæ‰€æœ‰å¸§
      function exportAllFrames() {
        try {
          const frames = renderer.exportAllFrames("image/png", 0.92);
          frames.forEach((frame, index) => {
            setTimeout(() => {
              downloadDataUrl(frame.dataUrl, `frame_${frame.index + 1}.png`);
            }, index * 100); // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
          });
          showMessage(`æˆåŠŸå¯¼å‡º ${frames.length} å¸§`, "success");
        } catch (error) {
          showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, "error");
        }
      }

      // åˆ›å»ºç²¾çµå›¾
      function createSpriteSheet() {
        try {
          const spriteCanvas = renderer.createSpriteSheet();
          if (spriteCanvas) {
            const dataUrl = spriteCanvas.toDataURL("image/png", 0.92);
            downloadDataUrl(dataUrl, "sprite_sheet.png");
            showMessage("ç²¾çµå›¾åˆ›å»ºæˆåŠŸ", "success");
          } else {
            showMessage("æ— æ³•åˆ›å»ºç²¾çµå›¾", "error");
          }
        } catch (error) {
          showMessage(`åˆ›å»ºç²¾çµå›¾å¤±è´¥: ${error.message}`, "error");
        }
      }

      // å¯¼å‡ºè°ƒè‰²æ¿
      function exportPalette() {
        try {
          if (gifData.globalColorTable.length > 0) {
            const paletteCanvas = GifUtils.createPaletteImage(
              gifData.globalColorTable
            );
            const dataUrl = paletteCanvas.toDataURL("image/png", 1.0);
            downloadDataUrl(dataUrl, "palette.png");
            showMessage("è°ƒè‰²æ¿å¯¼å‡ºæˆåŠŸ", "success");
          } else {
            showMessage("æ²¡æœ‰å…¨å±€è°ƒè‰²æ¿å¯å¯¼å‡º", "warning");
          }
        } catch (error) {
          showMessage(`å¯¼å‡ºè°ƒè‰²æ¿å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ä¸‹è½½åˆ†ææŠ¥å‘Š
      function downloadAnalysis() {
        try {
          const info = gifParser.getInfo();
          const analysis = GifUtils.analyzeGif(gifData);

          const report = {
            basicInfo: {
              version: gifData.header.version,
              dimensions: `${info.width}x${info.height}`,
              frameCount: info.frameCount,
              loopCount: info.loopCount,
              totalDuration: info.totalDuration,
            },
            technicalInfo: {
              hasGlobalColorTable: info.hasGlobalColorTable,
              globalColorTableSize: info.globalColorTableSize,
              backgroundColorIndex: gifData.logicalScreen.backgroundColorIndex,
              colorResolution: gifData.logicalScreen.colorResolution,
            },
            analysis: analysis,
            frames: gifData.frames.map((frame, index) => ({
              index: index + 1,
              width: frame.width,
              height: frame.height,
              left: frame.left,
              top: frame.top,
              delayTime: frame.delayTime,
              disposalMethod: frame.disposalMethod,
              transparentColorFlag: frame.transparentColorFlag,
              isInterlaced: frame.isInterlaced,
              colorTableSize: frame.colorTable.length,
              dataSize: frame.imageData.length,
            })),
            parseLog: {
              errors: gifData.errors,
              warnings: gifData.warnings,
            },
          };

          const json = JSON.stringify(report, null, 2);
          const blob = new Blob([json], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "gif_analysis_report.json";
          a.click();

          URL.revokeObjectURL(url);
          showMessage("åˆ†ææŠ¥å‘Šä¸‹è½½æˆåŠŸ", "success");
        } catch (error) {
          showMessage(`ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ${error.message}`, "error");
        }
      }

      // åˆ‡æ¢æ ‡ç­¾é¡µ
      function showTab(tabName) {
        // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
        const tabContents = document.querySelectorAll(".tab-content");
        tabContents.forEach((content) => content.classList.remove("active"));

        // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach((tab) => tab.classList.remove("active"));

        // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
      function showLoading(show) {
        const loadingIndicator = document.getElementById("loadingIndicator");
        const content = document.getElementById("content");

        if (show) {
          loadingIndicator.style.display = "block";
          content.style.display = "none";
          // æ¨¡æ‹Ÿè¿›åº¦æ¡
          let progress = 0;
          const interval = setInterval(() => {
            progress += Math.random() * 30;
            if (progress > 90) progress = 90;
            document.getElementById("progressBar").style.width = progress + "%";
          }, 100);
          loadingIndicator.dataset.interval = interval;
        } else {
          clearInterval(loadingIndicator.dataset.interval);
          document.getElementById("progressBar").style.width = "100%";
          setTimeout(() => {
            loadingIndicator.style.display = "none";
          }, 300);
        }
      }

      // æ˜¾ç¤ºæ¶ˆæ¯
      function showMessage(message, type) {
        const messageDiv = document.createElement("div");
        messageDiv.className = type;
        messageDiv.textContent = message;
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "20px";
        messageDiv.style.right = "20px";
        messageDiv.style.zIndex = "1000";
        messageDiv.style.padding = "10px 20px";
        messageDiv.style.borderRadius = "5px";
        messageDiv.style.maxWidth = "300px";

        document.body.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.remove();
        }, 3000);
      } // ä¸‹è½½æ•°æ®URL
      function downloadDataUrl(dataUrl, filename) {
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = filename;
        a.click();
      }

      // ============ GIFå‹ç¼©åŠŸèƒ½ ============

      // æ›´æ–°è´¨é‡æ˜¾ç¤ºå€¼
      function updateQualityValue(value) {
        document.getElementById("qualityValue").textContent = value;
      } // é¢„è§ˆå‹ç¼©æ•ˆæœ
      function previewCompression() {
        if (!gifData || !imageUtils) {
          showMessage("è¯·å…ˆåŠ è½½GIFæ–‡ä»¶å’Œå‹ç¼©å·¥å…·", "error");
          return;
        }

        const options = getCompressionOptions();
        const preview = imageUtils.createCompressionPreview(
          gifData,
          options,
          originalFileSize
        );

        const previewDiv = document.getElementById("compressionPreview");
        const contentDiv = document.getElementById("previewContent");

        // æ˜¾ç¤ºå®é™…æ–‡ä»¶å¤§å°å’Œä¼°ç®—å¤§å°
        const actualSizeText =
          originalFileSize > 0
            ? `${formatFileSize(originalFileSize)} (å®é™…)`
            : `${formatFileSize(preview.original.estimatedSize)} (ä¼°ç®—)`;

        contentDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
          <div>
            <h5 style="margin: 0 0 8px 0; color: #333;">åŸå§‹</h5>
            <p style="margin: 2px 0;">${preview.original.width}Ã—${
          preview.original.height
        }</p>
            <p style="margin: 2px 0;">${preview.original.frameCount} å¸§</p>
            <p style="margin: 2px 0;">${actualSizeText}</p>
          </div>
          <div style="color: #007bff;">
            <h5 style="margin: 0 0 8px 0;">å‹ç¼©å</h5>
            <p style="margin: 2px 0;">${preview.compressed.width}Ã—${
          preview.compressed.height
        }</p>
            <p style="margin: 2px 0;">${preview.compressed.frameCount} å¸§</p>
            <p style="margin: 2px 0;">${formatFileSize(
              preview.compressed.estimatedSize
            )} (é¢„ä¼°)</p>
          </div>
          <div style="color: #28a745;">
            <h5 style="margin: 0 0 8px 0;">å‡å°‘</h5>
            <p style="margin: 2px 0;">å°ºå¯¸: ${
              preview.reduction.pixelReduction
            }</p>
            <p style="margin: 2px 0;">å¸§æ•°: ${
              preview.reduction.frameReduction
            }</p>
            <p style="margin: 2px 0;">å¤§å°: ${
              preview.reduction.sizeReduction
            }</p>
          </div>
        </div>
        <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 4px;">
          <strong>å‹ç¼©è®¾ç½®:</strong> è´¨é‡=${preview.settings.quality}, æ–¹æ³•=${
          preview.settings.method
        }, å¸§æ­¥é•¿=${preview.settings.frameStep}
        </div>
      `;

        previewDiv.style.display = "block";
        showMessage("å‹ç¼©é¢„è§ˆç”Ÿæˆå®Œæˆ", "success");
      } // è·å–å‹ç¼©é€‰é¡¹
      function getCompressionOptions() {
        const width =
          parseInt(document.getElementById("compressWidth").value) || null;
        const height =
          parseInt(document.getElementById("compressHeight").value) || null;
        const quality =
          parseInt(document.getElementById("compressQuality").value) || 15;
        const maxFrames =
          parseInt(document.getElementById("maxFrames").value) || null;
        const dither = document.getElementById("enableDither").checked;
        const debug = document.getElementById("debugMode").checked;
        const useDirectPixelMethod = document.getElementById(
          "useDirectPixelMethod"
        ).checked;
        const useImprovedMethod =
          document.getElementById("useImprovedMethod").checked;

        // è·å–å¸§å¤„ç†ç­–ç•¥
        const frameStrategy = document.getElementById("frameStrategy").value;
        let frameStep = 1; // é»˜è®¤ä¸è·³å¸§

        if (frameStrategy === "manual-skip") {
          frameStep = parseInt(document.getElementById("frameStep").value) || 1;
        } else if (frameStrategy === "keep-all") {
          frameStep = 1;
        }
        // auto-skipä¼šåœ¨calculateFrameStepä¸­æ ¹æ®qualityè‡ªåŠ¨å¤„ç†
        return {
          width,
          height,
          quality,
          maxFrames,
          frameStep: frameStrategy === "manual-skip" ? frameStep : undefined,
          useAutoFrameSkip: frameStrategy === "auto-skip",
          useDirectPixelMethod,
          useImprovedMethod,
          dither,
          debug,
          workers: 2,
          repeat: gifData.loopCount || 0,
          onProgress: updateCompressionProgress,
          onFrameAdded: updateFrameProgress,
        };
      }

      // å¼€å§‹å‹ç¼©
      async function startCompression() {
        if (!gifData || !imageUtils) {
          showMessage("è¯·å…ˆåŠ è½½GIFæ–‡ä»¶å’Œå‹ç¼©å·¥å…·", "error");
          return;
        }

        const options = getCompressionOptions();

        // æ˜¾ç¤ºè¿›åº¦
        showCompressionProgress(true);
        updateCompressionStatus("æ­£åœ¨åˆ†æåŸå§‹æ–‡ä»¶...");
        // è·å–åŸå§‹æ–‡ä»¶å¤§å°ä¿¡æ¯
        const originalInfo = gifParser.getInfo();
        const actualOriginalSize =
          originalFileSize > 0
            ? originalFileSize
            : originalInfo.width *
              originalInfo.height *
              originalInfo.frameCount *
              0.5;

        console.log("åŸå§‹GIFä¿¡æ¯:", {
          dimensions: `${originalInfo.width}x${originalInfo.height}`,
          frameCount: originalInfo.frameCount,
          actualSize:
            originalFileSize > 0
              ? `${(originalFileSize / 1024).toFixed(1)} KB`
              : "æœªçŸ¥",
          estimatedSize: `${(actualOriginalSize / 1024).toFixed(1)} KB`,
        });

        try {
          const startTime = Date.now();
          updateCompressionStatus("åˆå§‹åŒ–å‹ç¼©å™¨...");

          // æ‰§è¡Œå‹ç¼©
          const compressedData = await imageUtils.compressGif(gifData, options);

          const endTime = Date.now();
          const duration = ((endTime - startTime) / 1000).toFixed(1);

          // è®¡ç®—å®é™…å‹ç¼©æ¯”
          let actualSize = 0;
          let compressionRatio = 0;
          if (compressedData instanceof Blob) {
            actualSize = compressedData.size;
            compressionRatio = (
              ((actualOriginalSize - actualSize) / actualOriginalSize) *
              100
            ).toFixed(1);
          } else {
            actualSize = new Blob([compressedData]).size;
            compressionRatio = "N/A (å…œåº•æ–¹æ¡ˆ)";
          }

          console.log("å‹ç¼©ç»“æœ:", {
            method: imageUtils.gifJsAvailable ? "gif.js" : "å…œåº•æ–¹æ¡ˆ",
            originalActual: `${(actualOriginalSize / 1024).toFixed(1)} KB`,
            compressed: `${(actualSize / 1024).toFixed(1)} KB`,
            reduction: `${compressionRatio}%`,
            duration: `${duration}s`,
          });

          // æ˜¾ç¤ºç»“æœ
          showCompressionResult(compressedData, duration, options, {
            originalSize: actualOriginalSize,
            compressedSize: actualSize,
            compressionRatio: compressionRatio,
          });

          if (
            compressionRatio !== "N/A (å…œåº•æ–¹æ¡ˆ)" &&
            parseFloat(compressionRatio) > 0
          ) {
            showMessage(
              `GIFå‹ç¼©å®Œæˆï¼Œå‡å°‘äº† ${compressionRatio}%ï¼Œè€—æ—¶ ${duration} ç§’`,
              "success"
            );
          } else if (compressionRatio !== "N/A (å…œåº•æ–¹æ¡ˆ)") {
            showMessage(`å‹ç¼©å®Œæˆä½†æ–‡ä»¶å¯èƒ½å˜å¤§ï¼Œè¯·è°ƒæ•´å‹ç¼©å‚æ•°`, "warning");
          } else {
            showMessage(`ä½¿ç”¨å…œåº•æ–¹æ¡ˆå®Œæˆå¤„ç†ï¼Œè€—æ—¶ ${duration} ç§’`, "info");
          }
        } catch (error) {
          console.error("å‹ç¼©å¤±è´¥:", error);
          showMessage(`å‹ç¼©å¤±è´¥: ${error.message}`, "error");
          updateCompressionStatus(`å‹ç¼©å¤±è´¥: ${error.message}`);
        }

        showCompressionProgress(false);
      }

      // æ›´æ–°å‹ç¼©è¿›åº¦
      function updateCompressionProgress(progress) {
        const progressBar = document.getElementById("compressionProgressBar");
        const percentage = Math.round(progress * 100);
        progressBar.style.width = percentage + "%";
        updateCompressionStatus(`å‹ç¼©è¿›åº¦: ${percentage}%`);
      }

      // æ›´æ–°å¸§æ·»åŠ è¿›åº¦
      function updateFrameProgress(current, total) {
        updateCompressionStatus(`æ·»åŠ å¸§: ${current}/${total}`);
      }

      // æ›´æ–°å‹ç¼©çŠ¶æ€
      function updateCompressionStatus(status) {
        const statusDiv = document.getElementById("compressionStatus");
        statusDiv.textContent = status;
      }

      // æ˜¾ç¤º/éšè—å‹ç¼©è¿›åº¦
      function showCompressionProgress(show) {
        const progressDiv = document.getElementById("compressionProgress");
        progressDiv.style.display = show ? "block" : "none";

        if (show) {
          document.getElementById("compressionProgressBar").style.width = "0%";
          updateCompressionStatus("å‡†å¤‡ä¸­...");
        }
      } // æ˜¾ç¤ºå‹ç¼©ç»“æœ
      function showCompressionResult(
        compressedData,
        duration,
        options,
        sizeInfo = null
      ) {
        const resultDiv = document.getElementById("compressionResult");
        const contentDiv = document.getElementById("compressionResultContent");

        let resultHtml = `
        <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
          <h5 style="margin: 0 0 10px 0; color: #155724;">âœ… å‹ç¼©æˆåŠŸ</h5>
          <p style="margin: 5px 0;">å‹ç¼©æ—¶é—´: ${duration} ç§’</p>
          <p style="margin: 5px 0;">å‹ç¼©æ–¹æ³•: ${
            imageUtils.gifJsAvailable ? "gif.js (é«˜è´¨é‡)" : "å…œåº•æ–¹æ¡ˆ"
          }</p>
      `;
        if (compressedData instanceof Blob) {
          const sizeKB = (compressedData.size / 1024).toFixed(1);
          resultHtml += `<p style="margin: 5px 0;">å‹ç¼©åå¤§å°: ${sizeKB} KB</p>`;

          // æ˜¾ç¤ºå‹ç¼©æ¯”ä¿¡æ¯
          if (sizeInfo) {
            const originalKB = (sizeInfo.originalSize / 1024).toFixed(1);
            resultHtml += `<p style="margin: 5px 0;">åŸå§‹æ–‡ä»¶å¤§å°: ${originalKB} KB</p>`;
            if (sizeInfo.compressionRatio !== "N/A (å…œåº•æ–¹æ¡ˆ)") {
              const ratio = parseFloat(sizeInfo.compressionRatio);
              const color = ratio > 0 ? "#28a745" : "#dc3545";
              resultHtml += `<p style="margin: 5px 0; color: ${color};">å‹ç¼©æ¯”: ${sizeInfo.compressionRatio}%</p>`;

              if (ratio <= 0) {
                resultHtml += `<div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; margin: 8px 0;">
                âš ï¸ æ–‡ä»¶å¯èƒ½å˜å¤§äº†ï¼Œå»ºè®®è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š<br>
                â€¢ æé«˜å‹ç¼©è´¨é‡å€¼ (15-25)<br>
                â€¢ å‡å°‘ç›®æ ‡å°ºå¯¸<br>
                â€¢ é™åˆ¶æœ€å¤§å¸§æ•°<br>
                â€¢ å¯ç”¨æŠ–åŠ¨
              </div>`;
              }
            }
          }
        } else {
          const sizeKB = (new Blob([compressedData]).size / 1024).toFixed(1);
          resultHtml += `<p style="margin: 5px 0;">æ•°æ®å¤§å°: ${sizeKB} KB (JSONæ ¼å¼)</p>`;
        }

        resultHtml += `</div>`;

        // æ·»åŠ å‹ç¼©å‚æ•°ä¿¡æ¯
        resultHtml += `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
          <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ”§ å‹ç¼©å‚æ•°</h5>
          <p style="margin: 2px 0;">è´¨é‡ç­‰çº§: ${
            options.quality
          } (1-30ï¼Œè¶Šå°è´¨é‡è¶Šé«˜)</p>
          <p style="margin: 2px 0;">ç›®æ ‡å°ºå¯¸: ${options.width || "åŸå§‹"}Ã—${
          options.height || "åŸå§‹"
        }</p>
          <p style="margin: 2px 0;">æœ€å¤§å¸§æ•°: ${
            options.maxFrames || "ä¸é™åˆ¶"
          }</p>
          <p style="margin: 2px 0;">æŠ–åŠ¨: ${
            options.dither ? "å¯ç”¨" : "ç¦ç”¨"
          }</p>
          <p style="margin: 2px 0;">å·¥ä½œçº¿ç¨‹: ${options.workers}</p>
        </div>
      `;

        // æ·»åŠ ä¸‹è½½æŒ‰é’®
        resultHtml += `
        <div style="text-align: center;">
          <button class="export-btn" onclick="downloadCompressedGif()" style="background: #28a745; margin-right: 10px;">
            ğŸ’¾ ä¸‹è½½å‹ç¼©æ–‡ä»¶
          </button>
          <button class="export-btn" onclick="resetCompression()" style="background: #6c757d;">
            ğŸ”„ é‡æ–°å‹ç¼©
          </button>
        </div>
      `;

        contentDiv.innerHTML = resultHtml;
        resultDiv.style.display = "block";

        // ä¿å­˜å‹ç¼©ç»“æœä¾›ä¸‹è½½ä½¿ç”¨
        window.currentCompressedData = compressedData;
      }

      // ä¸‹è½½å‹ç¼©åçš„GIF
      function downloadCompressedGif() {
        if (!window.currentCompressedData) {
          showMessage("æ²¡æœ‰å¯ä¸‹è½½çš„å‹ç¼©æ–‡ä»¶", "error");
          return;
        }

        try {
          imageUtils.downloadCompressedGif(
            window.currentCompressedData,
            "compressed.gif"
          );
        } catch (error) {
          showMessage(`ä¸‹è½½å¤±è´¥: ${error.message}`, "error");
        }
      }

      // é‡ç½®å‹ç¼©ç•Œé¢
      function resetCompression() {
        // éšè—è¿›åº¦å’Œç»“æœ
        document.getElementById("compressionProgress").style.display = "none";
        document.getElementById("compressionResult").style.display = "none";
        document.getElementById("compressionPreview").style.display = "none";

        // é‡ç½®è¿›åº¦æ¡
        document.getElementById("compressionProgressBar").style.width = "0%";
        document.getElementById("compressionStatus").textContent = "å‡†å¤‡ä¸­...";
        // æ¸…é™¤å‹ç¼©æ•°æ®
        window.currentCompressedData = null;

        showMessage("å‹ç¼©å·²é‡ç½®", "info");
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }
    </script>
  </body>
</html>
