<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIFèƒŒæ™¯è‰²ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .fix-info {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .fix-info h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
        }
        
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        
        .background-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .bg-option {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }
        
        .bg-option:hover {
            background: #f0f0f0;
        }
        
        .bg-option.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .canvas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .canvas-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .canvas-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .canvas-wrapper {
            background: white;
            padding: 10px;
            border-radius: 4px;
            display: inline-block;
            position: relative;
        }
        
        .canvas-wrapper.checkered {
            background-image: 
                linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .canvas-wrapper canvas {
            border: 1px solid #999;
            display: block;
        }
        
        .controls {
            text-align: center;
            margin: 15px 0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        input[type="file"] {
            margin: 10px 0;
            width: 100%;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .before-after {
            text-align: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .before-after.before {
            border-color: #ff9800;
            background: #fff3e0;
        }
        
        .before-after.after {
            border-color: #4caf50;
            background: #e8f5e8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ GIFèƒŒæ™¯è‰²ä¿®å¤æµ‹è¯•</h1>
        
        <div class="fix-info">
            <h3>âœ… ä¿®å¤å†…å®¹</h3>
            <ul>
                <li><strong>è‡ªåŠ¨èƒŒæ™¯æ£€æµ‹</strong> - ä¼˜å…ˆä½¿ç”¨GIFæ–‡ä»¶ä¸­å®šä¹‰çš„èƒŒæ™¯è‰²</li>
                <li><strong>æ™ºèƒ½é¢œè‰²å¤„ç†</strong> - é¿å…æ— æ•ˆé¢œè‰²ç´¢å¼•å¯¼è‡´çš„é»‘è‰²èƒŒæ™¯</li>
                <li><strong>èƒŒæ™¯è‰²é€‰é¡¹</strong> - æ”¯æŒé€æ˜ã€ç™½è‰²ã€é»‘è‰²æˆ–è‡ªå®šä¹‰èƒŒæ™¯</li>
                <li><strong>æ­£ç¡®çš„é€æ˜åº¦å¤„ç†</strong> - é€æ˜åƒç´ ä¸å†æ˜¾ç¤ºä¸ºé»‘è‰²</li>
                <li><strong>Disposal Methodä¿®å¤</strong> - æ­£ç¡®å¤„ç†å¸§é—´èƒŒæ™¯æ¢å¤</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>é€‰æ‹©GIFæ–‡ä»¶æµ‹è¯•</h3>
            <input type="file" id="fileInput" accept=".gif">
            
            <div class="info">
                <strong>æç¤ºï¼š</strong>è¯·é€‰æ‹©ä¸€ä¸ªæœ‰èƒŒæ™¯è‰²é—®é¢˜çš„GIFæ–‡ä»¶è¿›è¡Œæµ‹è¯•ã€‚ä¿®å¤åï¼ŒèƒŒæ™¯åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„é¢œè‰²è€Œä¸æ˜¯é»‘è‰²ã€‚
            </div>
            
            <div id="backgroundOptions" class="background-options" style="display: none;">
                <div class="bg-option active" data-bg="auto">è‡ªåŠ¨æ£€æµ‹</div>
                <div class="bg-option" data-bg="transparent">é€æ˜èƒŒæ™¯</div>
                <div class="bg-option" data-bg="white">ç™½è‰²èƒŒæ™¯</div>
                <div class="bg-option" data-bg="black">é»‘è‰²èƒŒæ™¯</div>
                <div class="bg-option" data-bg="#f0f0f0">ç°è‰²èƒŒæ™¯</div>
            </div>
            
            <div id="results"></div>
        </div>
    </div>

    <script src="GifParser.js"></script>
    <script>
        let currentGifData = null;
        let renderers = [];
        
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // èƒŒæ™¯é€‰é¡¹åˆ‡æ¢
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('bg-option')) {
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('active'));
                e.target.classList.add('active');
                
                // é‡æ–°æ¸²æŸ“
                const selectedBg = e.target.dataset.bg;
                updateRenderers(selectedBg);
            }
        });
        
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file || file.type !== 'image/gif') {
                showMessage('è¯·é€‰æ‹©GIFæ–‡ä»¶', 'error');
                return;
            }
            
            await testGifFile(file);
        }
        
        async function testGifFile(file) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>æ­£åœ¨è§£æGIFæ–‡ä»¶...</p>';
            
            try {
                // è§£æGIF
                const parser = await GifParser.fromFile(file, {
                    strict: false,
                    validateFrames: true,
                    maxFrames: 50
                });
                
                currentGifData = parser.parse();
                
                // æ˜¾ç¤ºèƒŒæ™¯é€‰é¡¹
                document.getElementById('backgroundOptions').style.display = 'flex';
                
                // åˆ›å»ºæµ‹è¯•ç•Œé¢
                createTestInterface();
                
                showMessage(`æˆåŠŸåŠ è½½GIF: ${file.name}`, 'success');
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ è§£æå¤±è´¥</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('GIFè§£æé”™è¯¯:', error);
            }
        }
        
        function createTestInterface() {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="info">
                    <h4>GIFä¿¡æ¯</h4>
                    <p><strong>å°ºå¯¸:</strong> ${currentGifData.logicalScreen.width} x ${currentGifData.logicalScreen.height}</p>
                    <p><strong>å¸§æ•°:</strong> ${currentGifData.frames.length}</p>
                    <p><strong>èƒŒæ™¯è‰²ç´¢å¼•:</strong> ${currentGifData.logicalScreen.backgroundColorIndex}</p>
                    <p><strong>å…¨å±€é¢œè‰²è¡¨:</strong> ${currentGifData.logicalScreen.hasGlobalColorTable ? 'æœ‰' : 'æ— '} 
                       ${currentGifData.globalColorTable.length > 0 ? `(${currentGifData.globalColorTable.length}è‰²)` : ''}</p>
                </div>
                
                <div class="comparison">
                    <div class="before-after before">
                        <h4>ğŸ”´ ä¿®å¤å‰æ•ˆæœ</h4>
                        <p>å¯èƒ½å‡ºç°é»‘è‰²èƒŒæ™¯</p>
                        <div class="canvas-wrapper checkered" id="beforeWrapper">
                            <!-- è¿™é‡Œä¼šæ”¾ç½®ä¿®å¤å‰çš„canvas -->
                        </div>
                    </div>
                    
                    <div class="before-after after">
                        <h4>âœ… ä¿®å¤åæ•ˆæœ</h4>
                        <p>æ­£ç¡®çš„èƒŒæ™¯è‰²å¤„ç†</p>
                        <div class="canvas-wrapper checkered" id="afterWrapper">
                            <!-- è¿™é‡Œä¼šæ”¾ç½®ä¿®å¤åçš„canvas -->
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="renderFirstFrame()">æ˜¾ç¤ºç¬¬1å¸§</button>
                    <button onclick="renderRandomFrame()">éšæœºå¸§æµ‹è¯•</button>
                    <button onclick="playAnimation()">æ’­æ”¾åŠ¨ç”»</button>
                    <button onclick="stopAnimation()">åœæ­¢æ’­æ”¾</button>
                    <button onclick="exportFrames()">å¯¼å‡ºå¸§æµ‹è¯•</button>
                </div>
                
                <div id="frameInfo"></div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            createRenderers();
        }
        
        function createRenderers() {
            // æ¸…ç†æ—§çš„æ¸²æŸ“å™¨
            renderers.forEach(renderer => renderer.destroy && renderer.destroy());
            renderers = [];
            
            const selectedBg = document.querySelector('.bg-option.active').dataset.bg;
            
            // åˆ›å»º"ä¿®å¤å‰"çš„æ¸²æŸ“å™¨ï¼ˆä½¿ç”¨å¯èƒ½æœ‰é—®é¢˜çš„è®¾ç½®ï¼‰
            const beforeRenderer = new GifRenderer(currentGifData, {
                backgroundColor: 'black', // æ¨¡æ‹Ÿå¯èƒ½å‡ºç°çš„é»‘è‰²èƒŒæ™¯é—®é¢˜
                scale: 1
            });
            
            // åˆ›å»º"ä¿®å¤å"çš„æ¸²æŸ“å™¨
            const afterRenderer = new GifRenderer(currentGifData, {
                backgroundColor: selectedBg,
                scale: 1
            });
            
            // æ·»åŠ åˆ°é¡µé¢
            const beforeWrapper = document.getElementById('beforeWrapper');
            const afterWrapper = document.getElementById('afterWrapper');
            
            beforeWrapper.innerHTML = '';
            afterWrapper.innerHTML = '';
            
            beforeWrapper.appendChild(beforeRenderer.canvas);
            afterWrapper.appendChild(afterRenderer.canvas);
            
            renderers = [beforeRenderer, afterRenderer];
            
            // æ¸²æŸ“ç¬¬ä¸€å¸§
            if (currentGifData.frames.length > 0) {
                renderFirstFrame();
            }
        }
        
        function updateRenderers(backgroundColor) {
            if (renderers.length > 1) {
                // é‡æ–°åˆ›å»ºä¿®å¤åçš„æ¸²æŸ“å™¨
                const afterRenderer = new GifRenderer(currentGifData, {
                    backgroundColor: backgroundColor,
                    scale: 1
                });
                
                const afterWrapper = document.getElementById('afterWrapper');
                afterWrapper.innerHTML = '';
                afterWrapper.appendChild(afterRenderer.canvas);
                
                renderers[1] = afterRenderer;
                
                // é‡æ–°æ¸²æŸ“å½“å‰å¸§
                const currentFrame = renderers[0].getCurrentFrameIndex();
                renderers.forEach(renderer => {
                    renderer.renderFrame(currentFrame);
                });
                
                updateFrameInfo(currentFrame);
            }
        }
        
        function renderFirstFrame() {
            if (renderers.length === 0) return;
            
            renderers.forEach(renderer => {
                renderer.renderFrame(0);
            });
            
            updateFrameInfo(0);
        }
        
        function renderRandomFrame() {
            if (renderers.length === 0 || currentGifData.frames.length === 0) return;
            
            const randomIndex = Math.floor(Math.random() * currentGifData.frames.length);
            
            renderers.forEach(renderer => {
                renderer.renderFrame(randomIndex);
            });
            
            updateFrameInfo(randomIndex);
        }
        
        function playAnimation() {
            if (renderers.length === 0) return;
            
            renderers.forEach(renderer => {
                renderer.play((frameIndex, frame) => {
                    updateFrameInfo(frameIndex);
                });
            });
        }
        
        function stopAnimation() {
            if (renderers.length === 0) return;
            
            renderers.forEach(renderer => {
                renderer.stop();
            });
        }
        
        function exportFrames() {
            if (renderers.length === 0) return;
            
            try {
                // å¯¼å‡ºä¿®å¤åæ¸²æŸ“å™¨çš„å‰å‡ å¸§
                const afterRenderer = renderers[1];
                const maxFrames = Math.min(3, currentGifData.frames.length);
                
                for (let i = 0; i < maxFrames; i++) {
                    afterRenderer.renderFrame(i);
                    const dataUrl = afterRenderer.exportFrame(i, 'image/png', 0.9);
                    
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = `fixed_frame_${i + 1}.png`;
                    a.click();
                }
                
                showMessage(`æˆåŠŸå¯¼å‡º ${maxFrames} å¸§`, 'success');
            } catch (error) {
                showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function updateFrameInfo(frameIndex) {
            const frameInfoDiv = document.getElementById('frameInfo');
            if (!frameInfoDiv || !currentGifData.frames[frameIndex]) return;
            
            const frame = currentGifData.frames[frameIndex];
            const bgColorIndex = currentGifData.logicalScreen.backgroundColorIndex;
            let bgColorInfo = 'æ— æ•ˆ';
            
            if (currentGifData.globalColorTable && 
                bgColorIndex < currentGifData.globalColorTable.length) {
                const bgColor = currentGifData.globalColorTable[bgColorIndex];
                bgColorInfo = `RGB(${bgColor.r}, ${bgColor.g}, ${bgColor.b})`;
            }
            
            frameInfoDiv.innerHTML = `
                <div class="info">
                    <h4>å½“å‰å¸§ä¿¡æ¯ (å¸§ ${frameIndex + 1})</h4>
                    <p><strong>å°ºå¯¸:</strong> ${frame.width}x${frame.height}</p>
                    <p><strong>ä½ç½®:</strong> (${frame.left}, ${frame.top})</p>
                    <p><strong>å»¶è¿Ÿ:</strong> ${frame.delayTime * 10}ms</p>
                    <p><strong>é€æ˜:</strong> ${frame.transparentColorFlag ? 'æ˜¯' : 'å¦'}</p>
                    <p><strong>é€æ˜è‰²ç´¢å¼•:</strong> ${frame.transparentColorIndex}</p>
                    <p><strong>GIFèƒŒæ™¯è‰²:</strong> ${bgColorInfo}</p>
                    <p><strong>é¢œè‰²è¡¨å¤§å°:</strong> ${frame.colorTable.length}</p>
                </div>
            `;
        }
        
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '1000';
            messageDiv.style.padding = '10px 15px';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.color = 'white';
            messageDiv.style.fontSize = '14px';
            messageDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            
            if (type === 'success') {
                messageDiv.style.background = '#4caf50';
            } else if (type === 'error') {
                messageDiv.style.background = '#f44336';
            } else {
                messageDiv.style.background = '#2196f3';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
