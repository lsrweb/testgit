<!-- 批量创建 -->
<?php echo $header;?>
<link rel="stylesheet" type="text/css" href="/assets/pages/css/profile.css">

<script src="/assets/js/avalon.js"></script>
<script type="text/javascript" src="/assets/js/clipboard.js-1.5.15/clipboard.min.js"></script>

<link rel="stylesheet" type="text/css" href="/assets/js/jcountdown/jcountdown.css">
<script type="text/javascript" src="/assets/js/jcountdown/jquery.jcountdown.min.js"></script>

<script type="text/javascript" src="/assets/layDate-v5.0.9/laydate/laydate.js"></script>
<link rel="stylesheet" type="text/css" href="/assets/layui/css/layui.css">
<script type="text/javascript" src="/assets/layui/layui.js"></script>
<link rel="stylesheet" href="/assets/css/commonheader.css?v=4">
<script type="text/javascript" src="/assets/js/commonheaderpub.js"></script>
<link rel="stylesheet" href="/assets/css/tableSearch.css" />



<style type="text/css">
  .table {
    background-color: #fff;
    overflow: hidden;
    padding-bottom: 20px;
  }

  .green {
    color: #7bce60
  }

  .kjdate {
    color: rgb(30, 159, 255);
    width: 240px;
    text-align: left;
    font-size: 13px;
    margin-top: 4px;
  }

  .kjdate span {
    margin-right: 16px;
    cursor: pointer;
    margin-top: 4px;
    display: inline-block;
  }

  .el-input__icon {
    line-height: 30px !important;
  }

  .el-select .el-input__inner:focus {
    border-color: #c0c4cc !important;
  }

  .search button {
    margin: 0 12px !important;
  }

  /* 机器人权限调整 */
  .authority .el-dialog__body {
    padding: 12px 20px;
  }

  .authority .el-form-item__content {
    text-align: left !important;
  }

  .robotLine {
    width: 100%;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .robotLine .line_part {
    width: 48%;
    text-align: center;
  }

  .line_part span {
    display: inline-block;
    margin-bottom: 10px;
  }

  .btns {
    text-align: center;
  }

  .table .btn {
    margin-top: 5px;
  }

  .deny_form_item {
    margin-bottom: 15px;
    padding: 0 30px;
    overflow: hidden;
  }

  .deny_form_item_title {
    width: 80px;
    text-align: right;
    float: left;
    line-height: 28px;
  }

  .data_item_content {
    float: left;
    width: calc(100% - 90px);
    padding-left: 15px;
  }

</style>

<button onclick="NotificationComm('hello word!!', { body: '新消息呀新消息' });">发送消息</button>

<div class="outbox" id="privilege">
  <div class="tljbox">
    <div class="search-line clearfix">
      <div class="search-item">
        <div class="search-title">UID</div>
        <el-input class="search-input" size="mini" v-model='params.uid' placeholder="UID" clearable @keyup.enter.native="getData('sousuo')"></el-input>
      </div>

      <div class="search-item">
        <div class="search-title">权限名</div>
        <el-select class="search-input" size="mini" v-model="params.type" placeholder="请选择" filterable clearable @change="getData('sousuo')">
          <el-option value="0" label="全部权限"></el-option>
          <el-option v-for="(value, key, index) in selectlist" :label="value" :value="key"></el-option>
        </el-select>
      </div>

      <div class="search-item">
        <div class="search-title">子权限</div>
        <el-input class="search-input" size="mini" v-model='params.sub_type' placeholder="子权限" clearable @keyup.enter.native="getData('sousuo')"></el-input>
      </div>

      <div class="search-item">
        <div class="search-title">到期状态</div>
        <el-select class="search-input" size="mini" v-model="params.timestatus" placeholder="选择到期状态" clearable @change="getData('sousuo')">
          <el-option value="0" label="全部"></el-option>
          <el-option v-for="(value, key, index) in quanxian" :label="value" :value="key"></el-option>
        </el-select>
      </div>

      <div class="search-item">
        <div class="search-title">排序</div>
        <el-select class="search-input" size="mini" v-model="params.sort_by" placeholder="排序状态" @change="getData('sousuo')">
          <el-option value="id_desc" label="选择排序"></el-option>
          <el-option value="end_time_asc" label="到期时间近->远"></el-option>
          <el-option value="end_time_desc" label="到期时间远->近"></el-option>
          <el-option value="create_time_desc" label="创建时间近->远"></el-option>
          <el-option value="create_time_asc" label="创建时间远->近"></el-option>
        </el-select>
      </div>

      <el-button type="primary" class="search-btn" size="mini" @click="getData('sousuo')">查询</el-button>
      <el-button type="success" class="search-btn" size="mini" @click='addprivilege("","","", "")'>新增</el-button>
      <el-button type="warning" class="search-btn" size="mini" @click='transferDialog = true'>时间换绑</el-button>
      <el-button type="info" class="search-btn" size="mini" @click='getTongji()'>统计</el-button>
      <el-button type="primary" class="search-btn" size="mini" @click="window.open('/admin/privilege/tongji')">统计图表</el-button>
      <el-button type="primary" class="search-btn" size="mini" @click="window.open('/admin/privilege/viptongji')">VIP统计图表</el-button>
    </div>
    <!-- 权限调整 -->
    <el-dialog title='时间换绑' class='authority' :close-on-click-modal='false' @close='clearAuthority' @open='getAuthorityList' width='900px' :visible.sync="transferDialog" append-to-body>
      <div slot='footer'>
        <div class='robotLine'>
          <div class="line_part">
            <span>原机器人</span>
            <el-input v-model='from_wxid' type='textarea' rows='12' placeholder="输入原机器人wxid,一行一个"></el-input>
          </div>
          <div class="line_part">
            <span>目标机器人</span>
            <el-input v-model='to_wxid' type='textarea' rows='12' placeholder="输入目标机器人wxid,一行一个"></el-input>
          </div>
        </div>
        <el-form label-width='80px' label-position="left">
          <el-form-item label='权限类型' style="margin-bottom: 0;">
            <el-select v-model='sel_model' filterable placeholder='请选择权限' size='small' style="width: 280px;">
              <el-option v-for="(item,index) in qx_list" :key='index' :label='item.name' :value='item.value'></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label='用户UID' style="margin-bottom: 0;">
            <el-input placeholder="请输入用户UID" v-model='uid' size='small' style="width: 280px;"></el-input>
          </el-form-item>
          <el-form-item label='检测奖励时间' style="margin-bottom: 0;" label-width='100px'>
            <el-switch v-model='check_jiangli' active-value='1' inactive-value='0' style="margin-right:10px"></el-switch>
            <span style="font-size: 12px;color:#F56C6C;">活动奖励的时间默认检测不支持换绑操作,若需要换绑请关闭该项检测开关</span>
          </el-form-item>
          <el-form-item label='扣除天数'>
            <el-input-number size='small' @blur='controlDay' @change='controlDay' :min='0' v-model="kou_chu_day" controls-position="right"></el-input-number>
          </el-form-item>
        </el-form>
        <div class="btns">
          <el-button size='small' @click='transferDialog = false'> 取 消 </el-button>
          <el-button size='small' type='primary' @click='saveAuthority'> 保 存 </el-button>
        </div>
      </div>
    </el-dialog>
    <div class="table">
      <table class="table table-striped table-bordered table-hover" style="font-size:12px;">
        <thead>
          <tr role="row" class="heading">
            <th bgcolor='#d7e8ff'>编号</th>
            <th bgcolor='#d7e8ff' style="width: 6em;">UID</th>
            <th bgcolor='#d7e8ff' style="width: 8em;">公众号ID</th>
            <th bgcolor='#d7e8ff' style="width: 14em;">权限名</th>
            <th bgcolor='#d7e8ff'>子权限</th>
            <th bgcolor='#d7e8ff' style="width: 14em;">扩展内容</th>
            <th bgcolor='#d7e8ff' style="width: 5em;">数量</th>
            <th bgcolor='#d7e8ff'>到期时间</th>
            <th bgcolor='#d7e8ff'>创建时间</th>
            <th bgcolor='#d7e8ff' style="width:14em;">备注</th>
            <th bgcolor='#d7e8ff'>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for='(el,index) in listData' :key="el.id" role="row" class="filter">
            <td>{{el.id}}</td>
            <td>{{el.uid}}</td>
            <td>{{el.uniacid}}</td>
            <td>{{el.type_name}}</td>
            <td>{{el.sub_type}}</td>
            <td>{{el.extend}}</td>
            <td>{{el.num}}</td>
            <td :class="el.end_time=='0'?'green':''">
              {{el.end_time=='0'?'永久':timestampToTime (el.end_time+'000', type = 0,13)}} <span style="color: red;" v-if="Number(new Date())>=Number(el.end_time*1000)&&el.end_time!='0'">(已到期)</span></td>
            <td>{{timestampToTime (el.create_time+'000', type = 0,13)}}</td>

            <td>{{el.remark}}</td>
            <td style="padding-bottom: 13px;">
              <a class="btn blue btn-xs" @click="addprivilege(el.uid,el.uniacid, el.type, el.id,el.end_time,el.num,el.sub_type)">修改</a>
              <a class="btn green btn-xs" @click="setRemark(el)">备注</a>
              <a class="btn red btn-xs" @click="delet(el.id)">删除</a>
              <span v-if="el.show_deny_menu == 1">
                <a class="btn red btn-xs" v-if="el.is_deny == 0" @click="denyDialogShow(el)">封禁</a>
                <a class="btn green btn-xs" v-else @click="denyjiechu(el)">解除封禁</a>
              </span>
              <a class="btn blue btn-xs" @click="swich(el.uid)">切换后台</a>
            </td>
          </tr>
        </tbody>
      </table>

      <div id="pagingdown" style="margin-top: 5px;float: right;"></div>

      <div id="add" style="width:390px ;text-align: center;margin-top: 10px;margin-bottom: 10px;display: none;">
        <div class="portlet-body form">
          <form role="form" class="form-horizontal">
            <div class="form-body">
              <div class="form-group">
                <label class="col-xs-3 control-label">UID:</label>
                <div class="col-xs-3">
                  <div class="layui-form">
                    <input type="text" id="tlj_ids" :disabled='changeflag' class="form-control input-medium" value="" v-model='addparams.uid' autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-xs-3 control-label">uniacid:</label>
                <div class="col-xs-3">
                  <div class="layui-form">
                    <input type="text" id="new_coupon_id" :disabled='changeflag' class="form-control input-medium" placeholder="" v-model='addparams.uniacid' autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-xs-3 control-label">权限:</label>
                <div class="col-xs-3">
                  <div class="layui-form">
                    <el-select v-model="addparams.type" placeholder="请选择" filterable size='small' style="width: 240px;">
                      <el-option value="0" label="权限名"></el-option>
                      <el-option v-for="(value, key, index) in selectlist" :label="value" :value="key"></el-option>
                    </el-select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-xs-3 control-label">子权限:</label>
                <div class="col-xs-3">
                  <div class="layui-form">
                    <input type="text" id="sub_type" class="form-control input-medium" placeholder="" v-model='addparams.sub_type' autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-xs-3 control-label">数量:</label>
                <div class="col-xs-3">
                  <div class="layui-form">
                    <input type="text" id="num" class="form-control input-medium" placeholder="" v-model='addparams.num' autocomplete="off">
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-xs-3 control-label">到期时间:</label>
                <div class="col-xs-3">
                  <div class="layui-form">
                    <input type="text" id="endtime" class="form-control input-medium" placeholder="" v-model='addparams.end_time' autocomplete="off">
                    <div class="kjdate">
                      <span @click="kjdate(31)">1个月</span> <span @click="kjdate(62)">2个月</span> <span @click="kjdate(93)">3个月</span> <span @click="kjdate(186)">半年</span> <span @click="kjdate(365)">一年</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <!--<div class="col-xs-offset-3 col-xs-3">-->
              <button type="button" class="btn blue" @click="save('')" style="margin-left: 30px;">永久权限</button>
              <button type="button" class="btn blue" @click="save('time')" style="margin-left: 40px;">指定时间</button>
              <!--</div>-->
            </div>
          </form>
        </div>
      </div>


      <div id="tongji" style="display:none;">
        <div style="padding: 5px;">
          <table class="table table-striped table-bordered table-hover" style="font-size:12px;">
            <thead>
              <tr role="row" class="heading">
                <th bgcolor='#d7e8ff'>编号</th>
                <th bgcolor='#d7e8ff'>权限名</th>
                <th bgcolor='#d7e8ff'>数量</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for='(el,index) in tongjiListData' :key="el.id" role="row" class="filter">
                <td>{{index+1}}</td>
                <td>{{el.type_name}}</td>
                <td>{{el.count}}</td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>

      <div id="fengjing" style="display:none;">
        <form role="form" class="form-horizontal" style="margin-top: 30px;overflow: hidden;">
          <div class="form-body">
            <div class="form-group">
              <label class="col-xs-3 control-label">UID:</label>
              <div class="col-xs-3">
                <div class="layui-form">
                  <input type="text" id="tlj_ids" :disabled='true' class="form-control input-medium" value="" v-model='denyItmeData.uid' autocomplete="off">
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="col-xs-3 control-label">权限:</label>
              <div class="col-xs-3">
                <div class="layui-form">
                  <input type="text" id="tlj_ids" :disabled='true' class="form-control input-medium" value="" v-model='denyItmeData.type_name' autocomplete="off">
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="col-xs-3 control-label">原因:</label>
              <div class="col-xs-3">
                <div class="layui-form" style="min-width: 240px;">
                  <!-- <input type="text" id="tlj_ids" :disabled='true' class="form-control input-medium" value="" v-model='denyRemark' autocomplete="off"> -->
                  <el-input type="textarea" :rows="2" placeholder="请输入内容" v-model="denyRemark">
                  </el-input>
                </div>
                <el-button @click="denyRemark = '超级单页涉及违法违规内容'" size="mini" type="primary" style="margin-top:10px">涉及违法违规</el-button>
              </div>
            </div>

            <div class="form-group">
              <label class="col-xs-3 control-label">解封时间:</label>
              <div class="col-xs-3">
                <div class="layui-form">
                  <!-- <input type="text" id="endtime" class="form-control input-medium" placeholder="请选择封禁时间"
                    v-model='denyTimer' autocomplete="off"> -->
                  <el-date-picker v-model="denyTimer" format="yyyy-MM-dd" value-format="yyyy-MM-dd" type="date" placeholder="请选择封禁时间" size="small" style="width: 240px;"> </el-date-picker>
                  <div class="kjdate">
                    <span @click="fengjinshijian(31)">1个月</span> <span @click="fengjinshijian(62)">2个月</span> <span @click="fengjinshijian(93)">3个月</span> <span @click="fengjinshijian(186)">半年</span> <span
                      @click="fengjinshijian(365)">一年</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-offset-3 col-xs-3" style="min-width: 240px;display: flex;align-items: center;justify-content: space-around;margin-bottom: 30px;margin-top: 14px;">
              <el-button @click="quxiaoDialog()" size="small">取 消</el-button>
              <el-button type="primary" @click="quedingFengjin()" size="small">确 定</el-button>
              <!-- <button type="button" class="btn blue" @click="save('')" style="margin-left: 30px;">永久权限</button> -->
              <!-- <button type="button" class="btn blue" @click="save('time')" style="margin-left: 40px;">指定时间</button> -->
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
  <!-- <div class="deny_title">
          <div v-if="denyItmeData.is_deny == 0">
            <i class="el-icon-warning" style="color: #E6A23C;" ></i>
            <span>确定要封禁?UID为{{denyItmeData.uid}}的{{denyItmeData.type_name}} 权限吗?</span>
          </div>
          <div class="deny_form_item">
            <div class="deny_form_item_title">封禁截止时间:</div>
            <div class="data_item-content">
              <el-date-picker  v-model="denyTimer" type="date" placeholder="选择封禁时间"> </el-date-picker>
            </div>
          </div>
          <div class="deny_form_item">
            <div class="deny_form_item_title">封禁原因(备注):</div>
            <div class="data_item-content">
              <el-input type="textarea"  :rows="2" placeholder="请输入封禁原因（备注）"  v-model="denyRemark"></el-input>
            </div>
          </div>
        </div> -->

  <!-- 封禁 -->
  <!-- <el-dialog title="子权限封禁" :visible.sync="denyDialog"  width="400px">
    <div slot="footer" class="dialog-footer" style="text-align: left;" >
        <div class="deny_form_item">
          <div class="deny_form_item_title">UID</div>
          <div class="data_item_content"style="line-height: 28px" >
            : {{denyItmeData.uid}}
          </div>
        </div>
        <div class="deny_form_item">
          <div class="deny_form_item_title">权限名称</div>
          <div class="data_item_content" style="line-height: 28px" >
            : {{denyItmeData.type_name}}
          </div>
        </div>
        <div class="deny_form_item">
          <div class="deny_form_item_title">截止时间</div>
          <div class="data_item_content">
            <el-date-picker size="mini" style="width: 260px;" v-model="denyTimer" type="date" placeholder="选择封禁时间"> </el-date-picker>
            <div class="quick_timer_box">
              <el-button type="text"  >1个月</el-button>
              <el-button type="text"  >2个月</el-button>
              <el-button type="text"  >3个月</el-button>
              <el-button type="text"  >半年</el-button>
              <el-button type="text"  >一年</el-button>
            </div>
          </div>
        </div>
        <div class="deny_form_item">
          <div class="deny_form_item_title">原因(备注)</div>
          <div class="data_item_content">
            <el-input type="textarea"  :rows="2" placeholder="请输入封禁原因（备注）"  v-model="denyRemark"></el-input>
          </div>
        </div>
      </div>
      <div>
      </div>
        <el-button @click="denyDialog = false" size="mini" >取 消123123</el-button>
        <el-button type="primary" @click="denyDialog = false" size="mini" >确111 定</el-button>
    </div>
  </el-dialog> -->


</div>
<script>

  var vm = new Vue({
    el: '#privilege',
    data: {
      params: {
        page: 1,
        uid: "",
        type: "0",
        sub_type: "",
        timestatus: '0',
        sort_by: 'id_desc'
      },
      quanxian: { '1': '未到期', '2': '已到期' },
      listData: '',
      tongjiListData: '',
      totalPage: 1,
      currPage: 1,
      selectlist: '',
      addparams: {
        uid: '',
        uniacid: 0,
        type: '0',
        end_time: '',
        num: 1,
        sub_type: "",


      },
      changeflag: false,
      itemid: '',
      url: '',
      adixparam: '',
      item_end_time: '',

      // 权限调整
      transferDialog: false,
      from_wxid: '',			//左侧机器人
      to_wxid: '',			//右侧机器人
      qx_list: [],		    //权限列表
      sel_model: '',			//选择的权限
      uid: '',
      check_jiangli: '1',	//检测奖励
      kou_chu_day: 3,		//扣除天数
      // 封禁
      denyDialog: false,
      denyLoading: false,
      denyTimer: '',
      denyRemark: '',
      denyItmeData: '',
    },
    components: {

    },
    mounted() {
      this.getselectlist();
      this.getData();
    },
    methods: {
      // 保存权限
      saveAuthority() {
        var that = this;
        if (!that.from_wxid) {
          that.$message({ message: '至少输入一条原机器人的wxid', type: "error", showClose: true, offset: 200, })
          return
        }
        if (!that.to_wxid) {
          that.$message({ message: '至少输入一条目标机器人的wxid', type: "error", showClose: true, offset: 200, })
          return
        }
        if (!that.sel_model) {
          that.$message({ message: '请选择转移权限', type: "error", showClose: true, offset: 200, })
          return
        }
        if (!that.uid) {
          that.$message({ message: '请输入用户uid', type: "error", showClose: true, offset: 200, })
          return
        }
        if (!that.kou_chu_day && that.kou_chu_day != '0') {
          that.$message({ message: '请设置扣除天数', type: "error", showClose: true, offset: 200, })
          return
        }
        var from_wxid = that.from_wxid.split(/[(\r\n)\r\n]+/);
        var to_wxid = that.to_wxid.split(/[(\r\n)\r\n]+/);
        var tips = '<br>每次换绑需要扣除' + that.kou_chu_day + '天的时间';
        that.$confirm('确定将服务到期时间更换到其他机器人上吗?' + (that.kou_chu_day > 0 ? tips : '') + ' <br> 换绑后当前机器人立即过期<br>时间换绑仅限于同功能的机器人之间进行操作?', '提示', {
          confirmButtonText: '确定换绑',
          cancelButtonText: '取消',
          type: 'warning',
          dangerouslyUseHTMLString: true
        }).then((op) => {
          if (op == 'confirm') {
            $.post('/admin/Privilege/timeReplace', {
              model: that.sel_model,
              from_wxid: from_wxid,
              uid: that.uid,
              check_jiangli: that.check_jiangli,
              to_wxid: to_wxid,
              kou_chu_day: that.kou_chu_day,
            }, function (json) {
              if (json.code == 200) {
                that.$message({ message: json.msg, type: 'success', showClose: true, offset: 200, })
                that.transferDialog = false;
              } else {
                that.$message({ message: json.msg, type: 'error', showClose: true, offset: 200, })
              }
            })
          }
        });
      },
      // 控制天数
      controlDay(event) {
        if (this.kou_chu_day < 0 || (this.kou_chu_day === null || this.kou_chu_day === undefined || this.kou_chu_day === '')) {
          this.kou_chu_day = 3;
        }
      },
      // 获取权限列表
      getAuthorityList() {
        var that = this;
        that.qx_list = [];
        $.getJSON('/admin/Privilege/getRobotPrivilegeTypeList', {}, function (json) {
          if (json.code == 200) {
            for (var key in json.data) {
              that.qx_list.push({
                name: json.data[key],
                value: key,
              })
            }
          } else {
            that.$message({ message: json.msg, type: 'error', showClose: true, offset: 200, })
          }
        })
      },
      // 关闭权限调整 清空
      clearAuthority() {
        this.from_wxid = '';
        this.to_wxid = '';
        this.check_jiangli = '1';
        this.uid = '';
        this.sel_model = '';
        this.kou_chu_day = 3;
      },
      swich(uid) {
        $.ajax({
          type: "POST",
          url: "/admin/KeFuSwichAccount/getAccount",
          data: { uid: uid },
          success: function (res) {
            data = res.data;
            $.ajax({
              type: "POST",
              url: "/admin/KeFuSwichAccount/swich",
              data: data,
              success: function (msg) {
                if (msg.code == 200) {
                  toastr.success('切换成功,准备刷新页面');
                  // location.href='/cms';
                  location.reload();
                }
              }
            });
          }
        })
      },
      kjdate(num) {
        let endtime = new Date(new Date(Number(this.item_end_time + '000')).toLocaleDateString()).getTime()
        let nowtime = new Date(new Date().toLocaleDateString()).getTime()
        if (!endtime || endtime < nowtime) {
          this.addparams.end_time = new Date(new Date().getTime() + 60 * 60 * 24 * 1000 * num).toLocaleDateString() + " 23:59:59"
        } else {
          this.addparams.end_time = new Date(endtime + 60 * 60 * 24 * 1000 * num).toLocaleDateString() + " 23:59:59"
        }
      },
      getselectlist() {
        var that = this
        $.ajax({
          type: "get",
          url: "/admin/Privilege/getTypeList",
          async: false,
          success: function (data) {
            that.selectlist = ''
            if (data.code == 200) {
              that.selectlist = data.data

            }

          }
        })
      },
      getData(pagetype) {
        var that = this
        var index = layer.load()
        if (pagetype == 'sousuo') {
          that.params.page = 1
        }
        $.getJSON('/admin/Privilege/getPrivilegeList', that.params, function (json) {
          if (json.code == 200) {
            var data = json.data;
            that.listData = data.list;
            that.totalPage = data.totalPage
            that.currPage = data.currPage
            that.getPage
            setTimeout(function () {
              toastr.success(json.msg + '，共计【' + json.data.total + '】条');

              layui.use(['laypage'], function () {
                let laypage = layui.laypage;
                laypage({
                  cont: 'pagingdown',
                  skin: '#1E9FFF',
                  first: 1,
                  curr: that.currPage,
                  last: that.totalPage,
                  pages: that.totalPage,
                  count: that.totalPage,
                  skip: true,
                  jump: function (obj, first) {
                    if (!first) {
                      that.params.page = obj.curr
                      that.getData();
                    }
                  }
                });

              })

            }, 100);


            layer.close(index);
          } else {
            layer.close(index);
            layer.msg(json.msg, { icon: 2 });
          }
        })
      },
      getTongji() {
        var that = this;
        $.getJSON('/admin/Privilege/getPrivilegeTongJi', {}, function (json) {
          if (json.code == 200) {
            var data = json.data;
            that.tongjiListData = data.list;

            setTimeout(function () {
              layer.open({
                type: 1,
                title: '未到期统计',
                skin: 'layui-layer', //加上边框
                area: ['auto', '600px'],
                content: $('#tongji')
              });
            }, 100);

          } else {

          }
        })
      },
      delet(id) {
        let that = this
        layer.confirm('确定删除吗?', {
          icon: 7,
          title: '提示'
        }, function () {
          index = layer.load();
          $.ajax({
            type: "POST",
            url: "/admin/Privilege/postDeletePrivilege",
            data: { id: id },
            success: function (json) {
              layer.closeAll();
              if (json.code == 200) {
                that.getData();
                layer.msg(json.msg, { icon: 1, time: 2000, shade: 0.8 });
              } else {
                layer.msg(json.msg, { icon: 2, time: 2000, shade: 0.8 });
              }
            }
          });
        })
      },
      // 封禁
      denyDialogShow(item) {
        var that = this;
        that.denyItmeData = item;
        setTimeout(function () {
          layer.open({
            type: 1,
            skin: 'layui-layer-rim', //加上边框
            zIndex: 100,
            area: ['420px', 'auto'], //宽高
            title: '权限封禁',
            shadeClose: true,
            content: $('#fengjing')
          });
        }, 200)
      },
      // 解除封禁
      denyjiechu(item) {
        var that = this;
        that.denyItmeData = item;
        that.deny()
      },
      fengjinshijian(daysToAdd) {
        var that = this;
        const currentDate = new Date();
        currentDate.setDate(currentDate.getDate() + daysToAdd);
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');  // 月份从0开始
        const day = String(currentDate.getDate()).padStart(2, '0');
        that.denyTimer = `${year}-${month}-${day}`;
      },
      quxiaoDialog() {
        var that = this;
        layer.closeAll();
      },
      // 确定封禁
      quedingFengjin() {
        var that = this;
        if (!that.denyTimer) {
          that.$message({ message: '请选择封禁时间', type: "error", showClose: true, offset: 200, })
          return
        }
        if (!that.denyRemark) {
          that.$message({ message: '请输入封禁原因', type: "error", showClose: true, offset: 200, })
          return
        }
        that.deny()
      },
      deny() {
        var that = this;
        var tisp = '<p>确定要封禁 uid:' + that.denyItmeData.uid + ' 的权限:' + that.denyItmeData.type_name + '吗?<br/>解封时间:' + that.denyTimer + '</p>'
        if (that.denyItmeData.is_deny == 1) {
          tisp = '<p>确定要解除封禁 uid:' + that.denyItmeData.uid + ' 的权限:' + that.denyItmeData.type_name + '吗?</p>'
        }
        that.$confirm(tisp, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          dangerouslyUseHTMLString: true,
          type: 'warning'
        }).then(() => {
          $.post('/admin/Privilege/deny', {
            id: that.denyItmeData.id,
            is_deny: that.denyItmeData.is_deny == 0 ? 1 : 0,
            remark: that.denyRemark,
            end_time: that.denyTimer,
          }, function (json) {
            if (json.code == 200) {
              layer.closeAll();
              that.getData();

              if (that.denyItmeData.is_deny == 0) {
                that.$message({ message: '封禁成功', type: 'success', showClose: true, offset: 200, })
              } else {
                that.$message({ message: '解封成功', type: 'success', showClose: true, offset: 200, })
              }
              that.denyRemark = '';
              that.denyTimer = '';
              that.denyItmeData = '';
            } else {
              that.$message({ message: json.msg, type: 'error', showClose: true, offset: 200, })
            }
          });
        }).catch(() => {

        })

      },
      getPage() {
        let that = this
        layui.use(['laypage'], function () {
          let laypage = layui.laypage;
          laypage({
            cont: 'pagingdown',
            skin: '#1E9FFF',
            first: 1,
            curr: that.currPage,
            last: that.totalPage,
            pages: that.totalPage,
            count: that.totalPage,
            skip: true,
            jump: function (obj, first) {
              if (!first) {
                that.params.page = obj.curr
                that.getData();
              }
            }
          });

        })
      },
      addprivilege(uid, uniacid, name, id, time, num, sub_type) {
        this.item_end_time = time;
        if (uid) {
          this.addparams.uid = uid
          this.changeflag = true
          this.itemid = id
          this.addparams.num = num
          this.url = '/admin/Privilege/postModifyPrivilege'
          this.addparams.sub_type = sub_type
          this.adixparam = { end_time: this.addparams.end_time, id: this.itemid }
        } else {
          this.addparams.uid = ''
          this.changeflag = false
          this.url = '/admin/Privilege/postAddPrivilege'
          this.adixparam = this.addparams
        }
        if (uniacid) {
          this.addparams.uniacid = uniacid
        } else {
          this.addparams.uniacid = 0
        }
        this.addparams.timestatus = 0
        if (time && time != '0') {
          this.addparams.end_time = timestampToTime(time + '000', type = 0, 13)
        } else {
          this.addparams.end_time = ''
        }

        if (name) {
          this.addparams.type = name
        } else {
          this.addparams.type = '0'
        }

        setTimeout(function () {
          layer.open({
            type: 1,
            skin: 'layui-layer-rim', //加上边框
            zIndex: 100,
            area: ['420px', 'auto'], //宽高
            title: '新增修改',
            shadeClose: true,
            content: $('#add')
          });
        }, 200)

      },
      setRemark(el) {
        var index = layer.prompt({
          formType: 2,
          area: ["400px", "200px"],
          title: el.id + '设置备注',
          value: el.remark,
        }, function (remark, index) {

          var load_index = layer.load();
          layer.msg('正在处理中')
          $.post('/admin/Privilege/setRemark', { id: el.id, remark: remark }, function (json) {
            layer.close(load_index);
            if (json.code == 200) {
              layer.msg(json.msg, { icon: 1, time: 1000 }, function () {
                el.remark = remark;
                layer.close(index);
              });
            } else {
              layer.msg(json.msg, { icon: 2 }, function () {
              });
            }
          }, "json");
        }
        );

        $('#layui-layer' + index + ' .layui-layer-content textarea').after('<div style="padding-top: 5px;    cursor: pointer;"><span class="layui-badge layui-bg-blue" data-clipboard-text="联盟试用7天">联盟试用7天</span></div>');

      },
      save(time) {
        if (time) {
          if (!this.addparams.end_time) {
            layer.msg('必须选择到期时间', { icon: 2 });
            return false
          } else {
            this.adixparam.end_time = this.addparams.end_time
          }
        } else {
          this.adixparam.end_time = '0'
        }

        this.adixparam.num = this.addparams.num
        this.adixparam.sub_type = this.addparams.sub_type

        $.ajax({
          type: "POST",
          url: vm.url,
          data: vm.adixparam,
          success: function (json) {
            layer.closeAll();
            if (json.code == 200) {
              vm.getData();
              vm.addparams = {
                uid: '',
                uniacid: 0,
                type: '0',
                end_time: '',
                num: 1,
                sub_type: ""
              },
                layer.msg(json.msg, { icon: 1, time: 2000, shade: 0.8 });
            } else {
              layer.msg(json.msg, { icon: 2, time: 2000, shade: 0.8 });
            }
          }
        });

      }
    },
  })

  laydate.render({
    elem: '#endtime',
    format: 'yyyy/MM/dd HH:mm:ss',
    trigger: 'click',
    type: 'datetime',
    done: function (val) {
      vm.addparams.end_time = val
    }
  });

</script>
<script src="/assets/js/commonheader.js?v=20200703"></script>



<script type="text/javascript">
  function NotificationComm(title, option) {
    // 判断浏览器是否兼容Notification消息通知
    if ('Notification' in window) {
      // 获取用户是否允许通知权限
      window.Notification.requestPermission(function (res) {
        console.log('Notification', res);
        // 允许
        if (res === 'granted') {
          var notification = new Notification(title || '这是一条新消息', Object.assign({}, {
            dir: "auto", // 字体排版,auto,lt,rt
            icon: '', // 通知图标
            body: '请尽快处理该消息', // 主体内容
            renotify: false // 当有新消息提示时，是否一直关闭上一条提示
          }, option || {}));
          // error事件处理函数
          notification.onerror = function (err) {
            console.log('onerror', err);

            throw err;
          }
          // show事件处理函数
          notification.onshow = function (ev) {
            console.log('onshow', ev);
          }
          // click事件处理函数
          notification.onclick = function (ev) {
            console.log('onclick', ev);
            notification.close();
          }
          // close事件处理函数
          notification.onclose = function (ev) {
            console.log('onclose', ev);
          }
        } else {
          alert('已不允许消息通知');
        }
      });
    } else {
      // 兼容当前浏览器不支持Notification的情况
      var documentTitle = document.title,
        index = 0;
      var time = setInterval(function () {
        index++;
        if (index % 2) {
          document.title = '【　　　】' + documentTitle;
        } else {
          document.title = '【新消息】' + documentTitle;
        }
      }, 1000);
      var fn = function () {
        if (!document.hidden && document.visibilityState === 'visible') {
          clearInterval(time);
          document.title = documentTitle;
        }
      }
      fn();
      document.addEventListener('visibilitychange', fn, false);
    }
  }
  // 启用消息通知
  // NotificationComm('hello word!!', { body: '新消息呀新消息' });
</script>
<?php echo $footer;?>
